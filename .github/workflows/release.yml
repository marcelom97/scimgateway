name: ðŸš€ Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update CHANGELOG.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          # Wait for the release to be fully published
          sleep 5
          
          # Get the release body from GitHub
          echo "Fetching release notes for ${TAG_NAME}..."
          gh release view "${TAG_NAME}" --json body --jq '.body' > /tmp/release_notes.txt
          
          # Get the current date
          RELEASE_DATE=$(date +%Y-%m-%d)
          
          # Get the previous tag for the comparison link
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          
          # Build the new changelog entry
          echo "## [${TAG_NAME}] - ${RELEASE_DATE}" > /tmp/new_entry.md
          echo "" >> /tmp/new_entry.md
          cat /tmp/release_notes.txt >> /tmp/new_entry.md
          echo "" >> /tmp/new_entry.md
          
          # Add comparison link
          if [ -n "${PREVIOUS_TAG}" ]; then
            echo "[${TAG_NAME}]: https://github.com/${REPO}/compare/${PREVIOUS_TAG}...${TAG_NAME}" >> /tmp/new_entry.md
          else
            echo "[${TAG_NAME}]: https://github.com/${REPO}/releases/tag/${TAG_NAME}" >> /tmp/new_entry.md
          fi
          echo "" >> /tmp/new_entry.md
          
          # Create updated CHANGELOG.md
          {
            head -n 6 CHANGELOG.md
            echo ""
            cat /tmp/new_entry.md
            tail -n +7 CHANGELOG.md
          } > /tmp/CHANGELOG_new.md
          
          # Replace the old CHANGELOG.md
          mv /tmp/CHANGELOG_new.md CHANGELOG.md
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit and push if there are changes
          if git diff --quiet CHANGELOG.md; then
            echo "No changes to CHANGELOG.md"
          else
            git add CHANGELOG.md
            git commit -m "docs: update CHANGELOG.md for ${TAG_NAME}"
            git push origin HEAD:main
            echo "Successfully updated CHANGELOG.md for ${TAG_NAME}"
          fi
